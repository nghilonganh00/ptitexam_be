let initListExam = {
  1: {
    examName: "Giữa kì môn Triết học Mac-Lenin 1",
    examType: "Thời gian cụ thể",
    examDescription: "",
    examStartTime: "2024-03-03",
    examEndTime: "2024-03-04",
    examCreatedAt: "29-2-2024",
    examlistQuestion: {
      1: {
        topic: "Chọn cách diễn đạt đúng về năng suất lao động?",
        listAnswer: {
          A: "Năng suất lao động là số sản phẩm được sản xuất ra trong doanh nghiệp",
          B: "Năng suất lao động là năng lực sản xuất của người lao động",
          C: "Năng suất lao động là khả năng cụ thể lao động",
          D: "Cả A và B",
        },
        correctAnswer: "A",
      },
      2: {
        topic: "Hãy chỉ ra nhận định đúng về chủ nghĩa tư bản độc quyền",
        listAnswer: {
          A: "Độc quyền không có khả năng và không bành trướng sang các lĩnh vực chính trị, xã hội",
          B: "Kết hợp với nhà nước hình thành độc quyền nhà nước chi phối quan hệ, đường lỗi đối nội với đối ngoại của quốc gia",
          C: "Không vì lợi ích của các tổ chức độc quyền, vì lợi ích của đa số nhân dân lao động",
          D: "Không kết hợp với các nhân viên chính phủ để thực hiện mục đích lợi ích nhóm",
        },
        correctAnswer: "A",
      },
      3: {
        topic: "Hàng hóa có 2 thuộc tính giá trị sử dụng và giá trị bởi vì:",
        listAnswer: {
          A: "Lao động của người sản xuất hàng hóa có tính hai mặt: lao động cụ thể và lao động trừu tượng",
          B: "Hai thuộc tính này gắn với hàng hóa",
          C: "Hàng hóa có hai mặt: lao động cụ thể và lao động trừu tượng",
          D: "Cả B và C",
        },
        correctAnswer: "C",
      },
      4: {
        topic: "Chọn đáp án đúng",
        listAnswer: {
          A: "Về mặt chính trị, hệ thống các nhà tài phiệt chi phối mọi hoạt động của các cơ quan nhà nước",
          B: "Về mặt chính trị, hệ thống các nhà tài phiệt luôn ủng hộ mọi hoạt động của các cơ quan nhà nước",
          C: "Về mặt chính trị, hệ thống các nhà tài phiệt luôn ủng hộ các phong trào đấu tranh của giai cấp công nhân",
          D: "Cả 3 đáp án",
        },
        correctAnswer: "A",
      },
      5: {
        topic: "Khái niệm kinh tế chính trị được xuất hiện lần đầu khi nào?",
        listAnswer: {
          A: "1815",
          B: "1715",
          C: "1615",
          D: "1917",
        },
        correctAnswer: "A",
      },
      6: {
        topic: "Lợi thuận thương nghiệp",
        listAnswer: {
          A: "Là toàn bộ giá trị thặng dư",
          B: "Trong lưu thông hàng hóa",
          C: "Cả 3 phương án trên",
          D: "Trong sản xuất hàng hóa",
        },
        correctAnswer: "B",
      },
      7: {
        topic:
          "Điền từ phù hợp nhất vào chỗ trống: 'Trong quá trình phát triển kinh tế thị trường cần chú ý tới những...của thi trường điều tiết khắc phục kịp thời của Nhà nước pháp quyền xã hội chủ nghĩa'",
        listAnswer: {
          A: "Thất bại và khuyết tất",
          B: "Hoạt động",
          C: "Vấn đề cốt lỗi",
          D: "Sự phát triển",
        },
        correctAnswer: "D",
      },
      8: {
        topic: "Tiền công danh nghĩa là gì?",
        listAnswer: {
          A: "Là giá cả sức lao động",
          B: "Là tổng số tiền nhận được trong một tháng",
          C: "Là tổng số tiền nhận được trong một tháng",
          D: "Là số tiền mà người công nhận được do bán sức lao động của mình cho nhà tư sản",
        },
        correctAnswer: "D",
      },
    },
  },
  2: {
    examName: "Cuối kì môn Vật lí 2, 3",
    examType: "Thời gian cụ thể",
    examDescription: "",
    examCreatedAt: "2022-03-03",
    examStartTime: "2022-03-03",
    examEndTime: "2022-03-03",
    examlistQuestion: {
      1: {
        topic: "Hiện tượng giao thoa ánh sáng chứng tỏ",
        listAnswer: {
          A: "Tính chất gián đoạn của ánh sáng",
          B: "Ánh sáng là một sống dọc",
          C: "Bản chất sóng của ánh sáng",
          D: "Ánh sáng là một sóng ngang",
        },
        correctAnswer: "A",
      },
      2: {
        topic: "Giao thoa ánh sáng là hiện tượng",
        listAnswer: {
          A: "Gặp nhau của hai hay nhiều sóng ánh sáng tự nhiên",
          B: "Gặp nhau của hai hay nhiều sóng ánh sáng kết hợp",
          C: "Gặp nhau của hai hay nhiều sóng ánh sáng phân cực",
          D: "Gặp nhau của hai nhiều sóng ánh sáng phân cực",
        },
        correctAnswer: "B",
      },
      3: {
        topic: "Hai sóng ánh sáng kết hợp là:",
        listAnswer: {
          A: "Hai sóng có hiệu pha thay đổi theo thời gian",
          B: "Hai sóng có tần số và hiệu quang lộ thay đổi theo thời gian",
          C: "Hai sóng khác tần số và hiệu quang lộ không thay đổi theo thời gian",
          D: "Hai sóng có hiệu pha không đổi theo thời gian",
        },
        correctAnswer: "A",
      },
      4: {
        topic:
          "Biểu thức của quang lộ L giữa hai điểm cách nhau một khoảng d trong môi trường chiếu suất n là",
        listAnswer: {
          A: "L = nd",
          B: "L = vt",
          C: "L = n/d",
          D: "L = d/n",
        },
        correctAnswer: "C",
      },
      5: {
        topic: "Sóng là quá trình",
        listAnswer: {
          A: "Truyền pha của dao động",
          B: "Truyền li đô của dao động",
          C: "Truyền biên độ của dao động",
          D: "Truyền dao động",
        },
        correctAnswer: "A",
      },
      6: {
        topic:
          "Trong thí nghiệm Young về giao thoa với ánh sáng đơn sắc có bước sóng A = 0,5um. Khoảng cách từ hai khe đến màn quan sát 1m, khoảng cách giữa hai khe sáng là 0,5mm. Khoảng cách giữa hai vân sáng liên tiếp là?",
        listAnswer: {
          A: "0,5 mm",
          B: "0,1 mm",
          C: "2 mm",
          D: "1 mm",
        },
        correctAnswer: "A",
      },
      7: {
        topic:
          "Trong thí nghiệm lâng về giao thoa với ánh sáng đơn sắc có bước sóng ) = 0,5um. Khoảng cách từ hai khe đến màn 1m, khoảng cách giữa hai khe sáng là 0,5mm. Tại m trên mà (E) cách vân sáng trung tâm 3,5 mm là vân sáng hay vân tối thứ mấy",
        listAnswer: {
          A: "Vân sáng thứ 3",
          B: "Vân sáng thứ 4",
          C: "Vân tối thứ 4",
          D: "Vân tối thứ 3",
        },
        correctAnswer: "D",
      },
      8: {
        topic:
          " Trong thí nghiệm lâng về giao thoa ánh sáng đơn sắc có bước sóng A = 0,5um. Khoảng cách từ hai khe đến màn quan sát 1m. Khoảng cách giữa hai khe sáng là 0,5mm. Bề rộng của vùng giao thoa quan sát được trên màn là 13mm. Số vân tối vân sáng trên miền giao thoa là?",
        listAnswer: {
          A: "13 vân sáng",
          B: "14 vân tối",
          C: "11 vân sáng",
          D: "12 vân tối",
        },
        correctAnswer: "B",
      },
    },
  },
  3: {
    examName: "Cuối kì môn Thông tin di động",
    examType: "Thời gian cụ thể",
    examDescription: "",
    examCreatedAt: "2022-03-03",
    examStartTime: "2022-03-03",
    examEndTime: "2022-03-03",
    examlistQuestion: {
      1: {
        topic:
          "Một MS muốn thực hiện cuộc gọi thì kênh đầu tiên MS sẽ sử dụng là",
        listAnswer: {
          A: "RACH",
          B: "SDCCH",
          C: "TCH",
          D: "BCCH",
        },
        correctAnswer: "A",
      },
      2: {
        topic:
          "Trên khung PCM ở giao diện Abis, với một BTS có cấu hình 4/4/4 thì số timeslotsử dụng cho lưu lượng TCH của tất cả TRX là",
        listAnswer: {
          A: "24",
          B: "12",
          C: "36",
          D: "32",
        },
        correctAnswer: "B",
      },
      3: {
        topic:
          "Khi sử dụng bộ kết hợp Combiner để kết nối 2 TRX thì công suất phát của các TRX giảm bao nhiêu Db",
        listAnswer: {
          A: "1",
          B: "3",
          C: "1.5",
          D: "2",
        },
        correctAnswer: "C",
      },
      4: {
        topic: "Các phần tử chính trong mạng di động gồm có",
        listAnswer: {
          A: "BTS, BSC, MSC",
          B: "BTS, BSC, TRAU, PCU, MSC/VLR, HLR",
          C: "BTS, BSC, TRAU, PCU, MSC/VLR, HLR, Truyền dẫn",
          D: "BTS, BSC, PCU, HLR, MSC/VLR",
        },
        correctAnswer: "A",
      },
      5: {
        topic: "Giao diện giữa BTS và BSC đực",
        listAnswer: {
          A: "Giao diện Ater",
          B: "Giao diện Abis",
          C: "Giao diện A",
          D: "Giao diện Atermux",
        },
        correctAnswer: "C",
      },
      6: {
        topic:
          "Giao diện giữa MS và BTS được gọi là giao diện gì? A. Giao diện Um",
        listAnswer: {
          A: "Giao diện Um",
          B: "Giao diện Abis",
          C: "Giao diện AXC",
          D: "Giao diện RSL",
        },
        correctAnswer: "A",
      },
      7: {
        topic: "Giao diện giữa BSC và TC được gọi là giao diện gì?",
        listAnswer: {
          A: "Giao diện Ater",
          B: "Giao diện Abis",
          C: "Giao diện A",
          D: "Giao diện A1",
        },
        correctAnswer: "A",
      },
    },
  },
};
let questionIndex = 0;
let listQuestion = {};

let listExams = [];

const timestampToDate = (timestamp) => {
  let date = new Date(timestamp);

  let year = date.getUTCFullYear();
  let month = String(date.getUTCMonth() + 1).padStart(2, "0");
  let day = String(date.getUTCDate()).padStart(2, "0");

  let formattedDateString = `${day}-${month}-${year}`;

  return formattedDateString;
};

const getToken = async () => {
  try {
    const response = await fetch(
      "http://localhost:8080/auth/read-spring-cookie",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
      }
    );
    const token = await response.text();
    return token;
  } catch (error) {
    console.error(error);
  }
};

const ExamAPI = {
  getAll: async () => {
    // const jwt = await getToken();
    // console.log("jwt: ", jwt);
    try {
      const requestOptions = {
        method: "GET",
        headers: {
          Accept: "application/json",
          "Content-Type": "application/json",
          // Authorization: `Bearer ${jwt}`,
        },
        // body: JSON.stringify(newExam),
      };
      const response = await fetch(
        "http://localhost:8080/exam/getAllExams",
        requestOptions
      );
      const exam = await response.json();
      console.log("exam: ", exam);
      return exam;
    } catch (error) {
      console.error(error);
    }
  },
  add: async (newExam) => {
    const {
      examName,
      examType,
      examStartTime,
      examEndTime,
      examDescription,
      examCreatedAt,
      examlistQuestion,
    } = newExam;

    const jwt = await getToken();
    console.log("jwt: ", jwt);
    // try {
    //   const requestOptions = {
    //     method: "POST",
    //     headers: {
    //       Accept: "application/json",
    //       "Content-Type": "application/json",
    //       Authorization: `Bearer ${jwt}`,
    //     },
    //     body: JSON.stringify(newExam),
    //   };
    //   const response = await fetch(
    //     "http://localhost:8080/exam/createExam",
    //     requestOptions
    //   );
    //   const exam = await response.json();
    //   console.log("exam: ", exam);
    //   return exam;
    // } catch (error) {
    //   console.error(error);
    // }
  },
};

const normalizeString = (inputString) => {
  let normalizedString = inputString;
  normalizedString = normalizedString.trim();
  normalizedString = normalizedString.replace(/\s+/g, " ");
  return normalizedString;
};

const reverseDateFormat = (inputDate) => {
  let dateParts = inputDate.split("-");
  dateParts.reverse();
  let reversedDate = dateParts.join("/");
  return reversedDate;
};

const scrollIntoView = (event, targetElementId) => {
  event.preventDefault();
  const targetElement = document.getElementById(targetElementId);
  // console.log("scrollIntoView");
  targetElement.scrollIntoView();
};

const getListExam = () => {
  return window.localStorage.get("list-exam");
};

const setListExam = (newListExam) => {
  window.localStorage.setItem("list-exam", JSON.stringify(newListExam));
};

if (!window.localStorage.getItem("list-exam")) {
  setListExam(initListExam);
}

let listExam = JSON.parse(window.localStorage.getItem("list-exam"));

const redirectToNewPage = (new_page, paramName, paramValue) => {
  if (paramName !== undefined && paramValue !== undefined) {
    const encodedParamName = encodeURIComponent(paramName);
    const encodedParamValue = encodeURIComponent(paramValue);

    const separator = new_page.includes("?") ? "&" : "?";

    window.location.href = `${new_page}${separator}${encodedParamName}=${encodedParamValue}`;
  } else {
    window.location.href = new_page;
  }
};

//Exam
const searchExam = (searchKey) => {
  searchKey = searchKey.toLowerCase().trim();

  if (searchKey === "") {
    loadExamPage(listExam);
    return;
  }

  const searchResult = Object.keys(listExam).filter((examKey) => {
    const exam = listExam[examKey];
    return exam["examName"].toLowerCase().includes(searchKey);
  });

  const listFilteredExam = Object.keys(listExam)
    .filter((examKey) => searchResult.includes(examKey))
    .reduce((obj, key) => {
      obj[key] = listExam[key];
      return obj;
    }, {});

  console.log(listFilteredExam);
  loadExamPage(listFilteredExam);
};

//Edit  page
const closePopUp = () => {
  document.getElementById("popup").style["display"] = "none";
};

const openPopUp = (examId, questionId) => {
  document.getElementById("popup").style["display"] = "block";

  const question = listExam[examId]["examlistQuestion"][questionId];
  const { topic, listAnswer, correctAnswer } = question;

  //Chèn câu hỏi
  document.getElementById("edit-id-question").innerText = examId;
  document.getElementById("edit-topic-input").value = topic;
  document.getElementById("edit-answer-a-input").value = listAnswer["A"];
  document.getElementById("edit-answer-b-input").value = listAnswer["B"];
  document.getElementById("edit-answer-c-input").value = listAnswer["C"];
  document.getElementById("edit-answer-d-input").value = listAnswer["D"];

  //Thêm onclick cho 2 button xóa và lưu
  document.getElementById("popup-del-question").onclick = function () {
    delQuestion(examId, questionId);
  };
  document.getElementById("popup-save-question").onclick = function () {
    saveQuestion(examId, questionId);
  };

  const radioInputs = document.getElementsByName("edit-answer");
  for (let i = 0; i < radioInputs.length; i++) {
    if (radioInputs[i].value === correctAnswer) {
      radioInputs[i].checked = true;
      break;
    }
  }
};

//General edit page

const closeGeneralPopUp = () => {
  document.getElementById("general-popup").style["display"] = "none";
};

const openGeneralPopup = () => {
  const examId = new URLSearchParams(window.location.search).get("id");
  const {
    examName,
    examType,
    examDescription,
    examTime,
    examStartTime,
    examEndTime,
  } = listExam[examId];

  document.getElementById("general-popup").style["display"] = "block";

  //Chèn thông tin chung của kì thi
  document.getElementById("popup-general-name").value = examName;
  document.getElementById("popup-general-type").value = examType;
  document.getElementById("popup-general-start-time").value =
    examType === "Thời gian cụ thể" ? examStartTime : null;
  // if (examType === "Thời gian cụ thể") console.log(examStartTime);
  document.getElementById("popup-general-end-time").value =
    examType === "Thời gian cụ thể" ? examEndTime : null;
  document.getElementById("popup-general-description").value = examDescription;
};

const saveGeneralPopup = () => {
  const examId = new URLSearchParams(window.location.search).get("id");
  const examName = normalizeString(
    document.getElementById("popup-general-name").value
  );
  const examType = document.getElementById("popup-general-type").value;
  const examStartTime =
    examType === "Thời gian cụ thể"
      ? document.getElementById("popup-general-start-time").value
      : null;
  const examEndTime =
    examType === "Thời gian cụ thể"
      ? document.getElementById("popup-general-end-time").value
      : null;
  const examDescription = normalizeString(
    document.getElementById("popup-general-description").value
  );

  if (!examName || examName === "") {
    document.getElementById("popup-general-name").focus();
    return;
  }
  if (examType === "Thời gian cụ thể") {
    if (examStartTime === "") {
      document.getElementById("popup-general-start-time").focus();
      return;
    } else if (examEndTime === "") {
      document.getElementById("popup-general-end-time").focus();
      return;
    }
  }

  listExam[examId] = {
    ...listExam[examId],
    examName: examName,
    examType: examType,
    examStartTime: examStartTime,
    examEndTime: examEndTime,
    examDescription: examDescription,
  };
  console.log("listExam: ", listExam);
  setListExam(listExam);
  closeGeneralPopUp();
  loadManageExamPage();
};

const delQuestion = (examId, questionId) => {
  delete listExam[examId]["examlistQuestion"][questionId];
  setListExam(listExam);
  loadManageExamPage(examId);
  closePopUp();
};

const addQuestionOnManage = () => {
  const examId = new URLSearchParams(window.location.search).get("id");
  const topic = document.getElementById("topic-input").value;
  const answer_a = document.getElementById("answer-a-input").value;
  const answer_b = document.getElementById("answer-b-input").value;
  const answer_c = document.getElementById("answer-c-input").value;
  const answer_d = document.getElementById("answer-d-input").value;

  document.getElementById("topic-input").value = "";
  document.getElementById("answer-a-input").value = "";
  document.getElementById("answer-b-input").value = "";
  document.getElementById("answer-c-input").value = "";
  document.getElementById("answer-d-input").value = "";

  let correct_answer = "";
  var checkbox = document.getElementsByName("manage-new-answer");
  for (var i = 0; i < checkbox.length; i++) {
    if (checkbox[i].checked === true) {
      correct_answer = checkbox[i].value;
    }
  }

  const newQuestion = {
    topic: topic,
    listAnswer: {
      A: answer_a,
      B: answer_b,
      C: answer_c,
      D: answer_d,
    },
    correctAnswer: correct_answer,
  };

  listExam[examId]["examlistQuestion"][
    Object.keys(listExam[examId]["examlistQuestion"]).length
  ] = newQuestion;
  setListExam(listExam);
  loadManageExamPage();
};

const saveQuestion = (examId, questionId) => {
  const topic = document.getElementById("edit-topic-input").value;
  const answer_a = document.getElementById("edit-answer-a-input").value;
  const answer_b = document.getElementById("edit-answer-b-input").value;
  const answer_c = document.getElementById("edit-answer-c-input").value;
  const answer_d = document.getElementById("edit-answer-d-input").value;

  let correctAnswer = "";
  const radioInputs = document.getElementsByName("edit-answer");
  for (let i = 0; i < radioInputs.length; i++) {
    if (radioInputs[i].checked === true) {
      correctAnswer = radioInputs[i].value;
      break;
    }
  }

  if (topic === "") {
    document.getElementById("edit-topic-input").focus();
    return;
  }
  if (answer_a === "") {
    document.getElementById("edit-answer-a-input").focus();
    return;
  }
  if (answer_b === "") {
    document.getElementById("edit-answer-b-input").focus();
    return;
  }
  if (answer_c === "") {
    document.getElementById("edit-answer-c-input").focus();
    return;
  }
  if (answer_d === "") {
    document.getElementById("edit-answer-d-input").focus();
    return;
  }

  const editedQuestion = {
    topic: topic,
    listAnswer: {
      A: answer_a,
      B: answer_b,
      C: answer_c,
      D: answer_d,
    },
    correctAnswer: correctAnswer,
  };

  listExam[examId]["examlistQuestion"][questionId] = editedQuestion;
  setListExam(listExam);
  loadManageExamPage(examId);
  closePopUp();
};

const delExam = (id) => {
  const examId = id || new URLSearchParams(window.location.search).get("id");
  document.addEventListener("DOMContentLoaded", loadManageExamPage(examId));

  delete listExam[examId];
  setListExam(listExam);
  redirectToNewPage("exam.html");
};

//Add page
const onChangeExamType = () => {
  const examType = document.getElementById("exam-type").value;
  const examTime = document.getElementById("create-exam-time");
  console.log(examType);
  if (examType === "Tự do") {
    examTime.style.visibility = "hidden";
  } else if (examType === "Thời gian cụ thể") {
    examTime.style.visibility = "visible";
  }
};

const addQuestion = (
  topic,
  answer_a,
  answer_b,
  answer_c,
  answer_d,
  correct_answer
) => {
  const newQuestionBox = document.createElement("div");
  const newQuestion = {
    topic: "",
    listAnswer: {
      A: "",
      B: "",
      C: "",
      D: "",
    },
    correctAnswer: "A",
  };

  newQuestionBox.classList.add("question-box");
  newQuestionBox.id = `questionIndex-${questionIndex}`;

  const answerContainer = document.createElement("div");
  answerContainer.innerHTML = `
    <span style="font-weight: 600">Câu hỏi ${questionIndex + 1}:</span>
    <span class="topic"
      >${topic}</span
    >
    <form onchange="onChangeCorrectAnswer(this, ${questionIndex})">
      <label class="answer">
        <input type="radio" name="answer" value="A"  ${
          correct_answer === "A" ? "checked" : ""
        } /> A.
        ${answer_a}
      </label>
      <label class="answer">
        <input type="radio" name="answer" value="B" ${
          correct_answer === "B" ? "checked" : ""
        }/> B.
        ${answer_b}
      </label>
      <label class="answer">
        <input type="radio" name="answer" value="C" ${
          correct_answer === "C" ? "checked" : ""
        }/> C.
         ${answer_c}
      </label>
      <label class="answer">
        <input type="radio" name="answer" value="D" ${
          correct_answer === "D" ? "checked" : ""
        }/> D.
        ${answer_d}
      </label>
    </form>
  `;
  newQuestionBox.appendChild(answerContainer);

  document.getElementById("list-question-box").appendChild(newQuestionBox);

  newQuestion["topic"] = topic;
  newQuestion["listAnswer"]["A"] = answer_a;
  newQuestion["listAnswer"]["B"] = answer_b;
  newQuestion["listAnswer"]["C"] = answer_c;
  newQuestion["listAnswer"]["D"] = answer_d;

  listQuestion[questionIndex] = newQuestion;

  questionIndex += 1;
};

const addQuestionByManual = () => {
  const topic = document.getElementById("topic-input").value;
  const answer_a = document.getElementById("answer-a-input").value;
  const answer_b = document.getElementById("answer-b-input").value;
  const answer_c = document.getElementById("answer-c-input").value;
  const answer_d = document.getElementById("answer-d-input").value;
  const correct_answer = "A";

  addQuestion(topic, answer_a, answer_b, answer_c, answer_d, correct_answer);
};

const addQuestionByFile = () => {
  const input = document.getElementById("create-file-input");

  if (input.files.length > 0) {
    const file = input.files[0];
    const reader = new FileReader();

    reader.onload = function (e) {
      const arrayBuffer = e.target.result;
      const workbook = XLSX.read(arrayBuffer, { type: "array" });

      const sheetName = workbook.SheetNames[0];

      const sheet = workbook.Sheets[sheetName];
      const lastRow = parseInt(sheet["!ref"].split(":")[1].match(/\d+/)[0]);
      for (let i = 2; i <= lastRow; i++) {
        const topic = sheet[`A${i}`].v;
        const answer_a = sheet[`B${i}`].v;
        const answer_b = sheet[`C${i}`].v;
        const answer_c = sheet[`D${i}`].v;
        const answer_d = sheet[`E${i}`].v;
        const correct_answer = sheet[`F${i}`].v;
        addQuestion(
          topic,
          answer_a,
          answer_b,
          answer_c,
          answer_d,
          correct_answer
        );
      }
    };
    reader.readAsArrayBuffer(file);
  }
};

function parseSheet(sheet) {
  const data = XLSX.utils.sheet_to_json(sheet, { header: 1, range: 1 });
  const result = [];
  let currentQuestion = {};

  for (const row of data) {
    if (row[0].startsWith("Câu")) {
      if (Object.keys(currentQuestion).length > 0) {
        result.push(currentQuestion);
      }

      currentQuestion = { question: row[0], options: [] };
    } else {
      const option = { A: row[1], B: row[2], C: row[3], D: row[4] };
      currentQuestion.options.push(option);
    }
  }

  if (Object.keys(currentQuestion).length > 0) {
    result.push(currentQuestion);
  }

  return result;
}

const onChangeCorrectAnswer = (form, id) => {
  const selectedValue = form.querySelector(
    'input[name="answer"]:checked'
  ).value;
  listQuestion[id]["correctAnswer"] = selectedValue;
};

const saveNewExam = () => {
  const dateNow = Date.now();

  const examName = normalizeString(document.getElementById("exam-name").value);
  const examType = document.getElementById("exam-type").value;
  const examStartTime = document.getElementById("exam-start-time").value;
  const examEndTime = document.getElementById("exam-end-time").value;
  const examDescription = normalizeString(
    document.getElementById("exam-description").value
  );
  const examCreatedAt = "5-3-2024";

  if (!examName || examName === "") {
    document.getElementById("exam-name").focus();
    return;
  }
  if (examType === "Thời gian cụ thể") {
    if (examStartTime === "") {
      document.getElementById("exam-start-time").focus();
      return;
    } else if (examEndTime === "") {
      document.getElementById("exam-end-time").focus();
      return;
    }
  }

  const newExam = {
    examName: examName,
    examType: examType,
    examStartTime: examStartTime,
    examEndTime: examEndTime,
    examDescription: examDescription,
    examCreatedAt: examCreatedAt,
    examlistQuestion: listQuestion,
  };
  listExam[dateNow] = newExam;
  // console.log("new exam: ", newExam);
  setListExam(listExam);
  ExamAPI.add(newExam);

  // redirectToNewPage("exam.html");
};

const loadExamPage = async (inputExam) => {
  listExams = await ExamAPI.getAll();

  document.getElementById("exam-list").innerHTML = "";
  document.getElementById("exam-boxs").innerHTML = "";

  const listLoadedExam = inputExam || listExam;
  let examId = 1;
  listExams.forEach((exam) => {
    const {
      examTitle,
      examDescription,
      examStartTime,
      examEndTime,
      // examlistQuestion,
      startTime,
      endTime,
    } = exam;

    const examRow = document.createElement("tr");
    examRow.onclick = function () {
      redirectToNewPage("manage-exam.html", "id", examKey);
    };

    examRow.innerHTML = `
      <td>${examId++}</td>
      <td>${examTitle}</td>
      <td></td>
      <td></td>
      <td>${timestampToDate(startTime)}</td>
      <td>${timestampToDate(endTime)}</td>
      <td>${examDescription}</td>
  `;

    const examBox = document.createElement("div");
    examBox.className = "exam-box";
    examBox.onclick = function () {
      redirectToNewPage("manage-exam.html", "id", examKey);
    };

    examBox.innerHTML = `
      <p>Ngày bắt đầu: ${examStartTime}</p>
      <p>Ngày kết thúc: ${examEndTime}</p>
      <div style="display: flex; align-items: center; gap: 4px">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 512 512"
          style="width: 16px"
        >
          <!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.-->
          <path
            d="M464 256A208 208 0 1 0 48 256a208 208 0 1 0 416 0zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zm169.8-90.7c7.9-22.3 29.1-37.3 52.8-37.3h58.3c34.9 0 63.1 28.3 63.1 63.1c0 22.6-12.1 43.5-31.7 54.8L280 264.4c-.2 13-10.9 23.6-24 23.6c-13.3 0-24-10.7-24-24V250.5c0-8.6 4.6-16.5 12.1-20.8l44.3-25.4c4.7-2.7 7.6-7.7 7.6-13.1c0-8.4-6.8-15.1-15.1-15.1H222.6c-3.4 0-6.4 2.1-7.5 5.3l-.4 1.2c-4.4 12.5-18.2 19-30.6 14.6s-19-18.2-14.6-30.6l.4-1.2zM224 352a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"
          />
        </svg>
        40 câu hỏi
      </div>
    `;

    document.getElementById("exam-list").appendChild(examRow);
    document.getElementById("exam-boxs").appendChild(examBox);
  });
};

const loadManageExamPage = () => {
  const examId = new URLSearchParams(window.location.search).get("id");
  const exam = listExam[examId];
  console.log("exam: ", exam);
  const {
    examName,
    examType,
    examStartTime,
    examEndTime,
    examDescription,
    examCreatedAt,
    examTime,
    examlistQuestion,
  } = exam;

  // Chèn thông tin chung
  document.getElementById("manage-exam-name").innerText = examName;
  document.getElementById("manage-general-exam-name").innerText = examName;
  document.getElementById("manage-exam-start-time").innerText =
    examType === "Thời gian cụ thể" ? reverseDateFormat(examStartTime) : null;
  document.getElementById("manage-exam-end-time").innerText =
    examType === "Thời gian cụ thể" ? reverseDateFormat(examEndTime) : null;
  document.getElementById("manage-exam-type").innerText = examType;
  document.getElementById("manage-exam-question-total").innerText =
    Object.keys(examlistQuestion).length;

  //Xóa tất cả các câu hỏi đang có
  const manageQuestionContent = document.getElementById(
    "manage-quetion-content"
  );

  while (manageQuestionContent.firstChild) {
    manageQuestionContent.removeChild(manageQuestionContent.firstChild);
  }

  //Thêm câu hỏi
  let questionIndex = 1;
  Object.keys(examlistQuestion).forEach((questionId) => {
    const question = examlistQuestion[questionId];
    const { topic, listAnswer, correctAnswer } = question;

    const newQuestionBox = document.createElement("div");
    newQuestionBox.classList.add("question-box");
    newQuestionBox.onclick = function () {
      openPopUp(examId, questionId);
    };
    const answerContainer = document.createElement("div");
    answerContainer.innerHTML = `
    <span class="topic" style="font-weight: 600"
      >Câu ${questionIndex++}:</span
    >
    <span>${topic}</span>
    <div class="manage-list-answer">
      <span class="answer"> 
        A. ${listAnswer["A"]}
      </span>
       <span class="answer"> 
        B. ${listAnswer["B"]}
      </span>
       <span class="answer"> 
        C. ${listAnswer["C"]}
      </span>
       <span class="answer"> 
        D. ${listAnswer["D"]}
      </span>
    </div>
    <div><span>Đáp án đúng: ${correctAnswer}</span></div>
  `;
    newQuestionBox.appendChild(answerContainer);

    document
      .getElementById("manage-quetion-content")
      .appendChild(newQuestionBox);
  });
};
